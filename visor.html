<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Salamanca</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="main.css" />
  
  <script src="jquery-3.7.1.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="leaflet-maskcanvas-master/src/QuadTree.js"></script>
  <script src="leaflet-maskcanvas-master/src/L.GridLayer.MaskCanvas.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.6/proj4.js"></script>
  
  <script type="text/javascript" src="salamanca.js"></script>
  <script type="text/javascript" src="municipios.js"></script>
  <script src="https://unpkg.com/shapefile@latest/dist/shapefile.js"></script>

  <style>
    #map { height: 800px; width: 100%; }
  </style>
</head>

<body>
<h1>VISOR SALAMANCA: CATASTRO Y CALLEJEROS</h1>
<div id="map"></div>

<script>
  console.log(L.TileLayer.maskCanvas);

  // Mapa centrado en Salamanca
  var map = L.map('map').setView([40.8374, -6.0287], 9.4);

  // Mapas base
  var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  var catastroLayer = L.tileLayer.wms("http://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?", {
    layers: "Catastro",
    format: 'image/jpeg',
    transparent: true,
    maxZoom: 25,
    version: '1.1.1',
    attribution: "DIRECCION GENERAL DEL CATASTRO"
  });

  var googleLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=m&hl=es&z={z}&x={x}&y={y}', {
    maxZoom: 25,
    attribution: '&copy; <a href="https://www.google.com/intl/es/help/terms_maps.html">Google Maps</a>'
  });

  var callejero = L.tileLayer.wms('http://www.ign.es/wms-inspire/ign-base?', {
    layers: 'IGNBaseTodo', 
    format: 'image/png',
    maxZoom: 25,
    transparent: true,
    attribution: '© Instituto Geográfico Nacional'
  });

  // Crear la capa de máscara
  var layerMaskSa = L.TileLayer.maskCanvas({
    radius: 5,
    useAbsoluteRadius: true,
    color: '#000',
    opacity: 0.5,
    noMask: false,
    lineColor: '#A00'
  }).addTo(map); // Agregamos la máscara al mapa

  // Estilos
  var estilo_1 = {
    "color": "#feb24c",
    "weight": 4,
    "opacity": 0.8
  };

  var estilo_2 = {
    "color": "#3182bd", 
    "weight": 3,
    "opacity": 0.5,
    "fill": true,
    "fillOpacity": 0.01 
  };

  // Capas
  var salamancaLayer = L.geoJson(salamanca, {
    onEachFeature: onEachLimites,
    style: estilo_1,
  }).addTo(map);

  var muniLayer = L.geoJson(municipios, {
    onEachFeature: onEachFeature,
    style: estilo_2,
  }).addTo(map);

  // Mapas agregados en una sola clase
  var baseMaps = {
    "Callejero": callejero,
    "Google Maps": googleLayer,
    "Open Street Map": osmLayer,
    "Catastro": catastroLayer
  };

  // Provincias y municipios en una sola clase
  var overlay = {
    "Provincia de Salamanca": salamancaLayer,
    "Municipios": muniLayer,
    "Máscara": layerMaskSa
  };

  // Funciones de popup para cada capa
  function onEachFeature(feature, layer) {
    var popupContent = feature.properties.D_MUN || "Sin nombre";
    layer.bindPopup(popupContent);
  }

  function onEachLimites(feature, layer) {
    var popupContent = "<b>Salamanca</b>";
    layer.bindPopup(popupContent);
  }

  // Control de escala
  L.control.scale({
    metric: true,
    imperial: false,
    maxWidth: 300,
    position: 'bottomleft'
  }).addTo(map);

  // Control de capas
  var control = L.control.layers(baseMaps, overlay, {
    position: 'topright',
    collapsed: false
  }).addTo(map);

  // Evento de clic en el mapa
  map.on('click', function(e) {
    var url = catastroLayer.getFeatureInfoUrl(e.latlng, {
      'info_format': 'application/json',
      'query_layers': 'Catastro',
      'buffer': 5,
      'layers': 'Catastro',
    });

    if (url) {
      fetch(url)
      .then(response => response.json())
      .then(data => {
        if (data.features.length > 0) {
          var properties = data.features[0].properties;
          var referencia = properties.TXTPARCELA;
          L.popup()
          .setLatLng(e.latlng)
          .setContent("Referencia Catastral: " + referencia)
          .openOn(map);
        } else {
          alert("No se encontró información en esta ubicación.");
        }
      })
      .catch(error => console.error('Error al obtener información:', error));
    }
  });

  // Función para obtener los parámetros de la URL
  function getQueryParam(param) {
    var urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  // Aquí se obtienen los parámetros lat, long y zoom
  var lat = parseFloat(getQueryParam('lat'));
  var lng = parseFloat(getQueryParam('lng'));
  var zoom = parseInt(getQueryParam('zoom'));

  // Verificar si los parámetros son válidos
  if (!isNaN(lat) && !isNaN(lng) && !isNaN(zoom)) {
    map.setView([lat, lng], zoom);
  }
</script>
</body>
</html> 
