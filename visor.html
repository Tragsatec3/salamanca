<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mapa de Salamanca</title>
  
  <!-- estilos CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

	
  <style>
    #map { height: 800px; width: 100%; }


  </style>
</head>

<body>
<h1>VISOR SALAMANCA: CATASTRO Y CALLEJEROS</h1>
<div id="map"></div>
	
<h2>Conversión de Coordenadas a WGS84</h2>
<label for="system">Selecciona el sistema de coordenadas:</label>
<select id="system">
  <option value="WGS84">WGS84 (Lat, Lon)</option>
  <option value="UTM30">UTM zona 30</option>
  <option value="UTM31">UTM zona 31</option>
</select>

<div>
  <label for="coordX">Coordenada X:</label>
  <input type="number" id="coordX" required>
</div>
<div>
  <label for="coordY">Coordenada Y:</label>
  <input type="number" id="coordY" required>
</div>
<button id="convert">Convertir y Generar URL</button>

<p id="result"></p>
	
<!-- Carga de plugins -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="leaflet.wms.js"></script>



<!-- rutas de los archivos js usados para cada capa -->
<script type="text/javascript" src="salamanca.js"></script>
<script type="text/javascript" src="municipios.js"></script>

<script src="https://unpkg.com/shapefile@latest/dist/shapefile.js"></script>

<!-- Mapa -->
<script>
  // Mapa centrado en Salamanca
  var map = L.map('map').setView([40.8374, -6.0287], 9);

  // Mapas base
  // Mapas base
  var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 25,
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  });

  var catastroLayer = L.tileLayer.wms("http://ovc.catastro.meh.es/Cartografia/WMS/ServidorWMS.aspx?", {
	   layers: "Catastro",//nombre de la capa (ver get capabilities)
	   format: 'image/jpeg',
	   transparent: true,
	   maxZoom: 25,
	   version: '1.1.1',//wms version (ver get capabilities)
	   attribution: "DIRECCION GENERAL DEL CATASTRO"
	});

  var googleLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=m&hl=es&z={z}&x={x}&y={y}', {
    maxZoom: 25,
    attribution: '&copy; <a href="https://www.google.com/intl/es/help/terms_maps.html">Google Maps</a>'
  }).addTo(map);
  
  var callejero = L.tileLayer.wms('http://www.ign.es/wms-inspire/ign-base?', {
    layers: 'IGNBaseTodo', 
    format: 'image/png',
    maxZoom: 25,
    transparent: true,
    attribution: '© Instituto Geográfico Nacional'
});

  // Estilos
  var estilo_1 = {
    "color": "#feb24c",
    "weight": 4,
    "opacity": 0.8
  };

var estilo_2 = {
    "color": "#3182bd", 
    "weight": 0.3,       
    "opacity": 0.5,     
    "fill": true,      
    "fillOpacity": 0.01 
};



  // Capas
  var salamancaLayer = L.geoJson(salamanca, {
    onEachFeature: onEachLimites,
    style: estilo_1,
  }).addTo(map);

  var muniLayer = L.geoJson(municipios, {
    onEachFeature: onEachFeature,
    style: estilo_2,
  });


  // Mapas agregados en una sola clase
 var baseMaps = {
    "Mapa Base IGN": callejero,
    "Google Maps": googleLayer,
    "Open Street Map": osmLayer,
    "Catastro": catastroLayer
  };

  // Provincias y municipios en una sola clase
  var overlay = {
    "Provincia de Salamanca": salamancaLayer,
    "Municipios": muniLayer
  };

  // Funciones de popup para cada capa
  function onEachFeature(feature, layer) {
    var popupContent = feature.properties.D_MUN || "Sin nombre";
    layer.bindPopup(popupContent);
  }

  function onEachLimites(feature, layer) {
    var popupContent = "<b>Salamanca</b>";
    layer.bindPopup(popupContent);
  }
  

//control escala
L.control.scale({
    metric: true,
    imperial: false,
    maxWidth: 300,
    position: 'bottomleft'
}).addTo(map);

 // control de los mapas base  
 L.control.layers(baseMaps, null, {
    position: 'bottomright',
    collapsed: false
  }).addTo(map);

  // Control de capas
  L.control.layers(null, overlay, {
    position: 'topright',
    collapsed: false
  }).addTo(map)


// Evento de clic en el mapa
map.on('click', function(e) {
  var url = catastroLayer.getFeatureInfoUrl(e.latlng, {
    'info_format': 'application/json',
    'query_layers': 'Catastro',
    'buffer': 5,
    'layers': 'Catastro',
  });

  if (url) {
  fetch(url)
  .then(response => response.json())
  .then(data => {
  if (data.features.length > 0) {
    var properties = data.features[0].properties;
    var referencia = properties.TXTPARCELA;
  L.popup()
  .setLatLng(e.latlng)
  .setContent("Referencia Catastral: " + referencia)
  .openOn(map);
 } else {
  alert("No se encontró información en esta ubicación.");
  }
  })
  .catch(error => console.error('Error al obtener información:', error));
  }
});

// Función para obtener los parámetros de la URL
function getQueryParam(param) {
    var urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// Aquí se obtienen los parámetros lat, long y zoom
var lat = parseFloat(getQueryParam('lat'));
var lng = parseFloat(getQueryParam('lng'));
var zoom = parseInt(getQueryParam('zoom'));

// Hay que verificar si los parámetros están bien, son válidos o no
if (!isNaN(lat) && !isNaN(lng) && !isNaN(zoom)) {
    map.setView([lat, lng], zoom);
}

// Conversión de coordenadas
  document.getElementById('convert').onclick = function() {
    var system = document.getElementById('system').value;
    var x = parseFloat(document.getElementById('coordX').value);
    var y = parseFloat(document.getElementById('coordY').value);
    var wgs84Coordinates;

    // Definir el sistema de referencia
    if (system === "WGS84") {
      wgs84Coordinates = [x, y];
    } else if (system === "UTM30") {
      var utm30 = "+proj=utm +zone=30 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
      wgs84Coordinates = proj4(utm30, [x, y]);
    } else if (system === "UTM31") {
      var utm31 = "+proj=utm +zone=31 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
      wgs84Coordinates = proj4(utm31, [x, y]);
    }

    // Extraer latitud y longitud
    var lng = wgs84Coordinates[0];
    var lat = wgs84Coordinates[1];

    // Construir la URL
    var url = `https://tragsatec3.github.io/salamanca/visor.html?lat=${lat}&lng=${lng}&zoom=15`;

    // Mostrar el resultado
    document.getElementById('result').innerHTML = `URL generada: <a href="${url}" target="_blank">${url}</a>`;
  }

  //Un del ratón
var coords = document.getElementById('coords');

map.on('mousemove', function(e) {
    coords.innerHTML = `Latitud: ${e.latlng.lat.toFixed(5)}, Longitud: ${e.latlng.lng.toFixed(5)}`;
});

</script>
</body>
</html>
